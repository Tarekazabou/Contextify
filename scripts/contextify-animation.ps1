# contextify-animation.ps1
# Ghosttime-inspired frame-based animation for Contextify
# High-performance, smooth rendering with pre-calculated frames
# Enhanced with TypeScript animation features

# Global color mapping (from TypeScript cli.ts)
$global:ColorMap = @{
    'black'          = "$([char]27)[30m"
    'red'            = "$([char]27)[31m"
    'green'          = "$([char]27)[32m"
    'yellow'         = "$([char]27)[33m"
    'blue'           = "$([char]27)[34m"
    'magenta'        = "$([char]27)[35m"
    'cyan'           = "$([char]27)[36m"
    'white'          = "$([char]27)[37m"
    'brightblack'    = "$([char]27)[90m"
    'brightred'      = "$([char]27)[91m"
    'brightgreen'    = "$([char]27)[92m"
    'brightyellow'   = "$([char]27)[93m"
    'brightblue'     = "$([char]27)[94m"
    'brightmagenta'  = "$([char]27)[95m"
    'brightcyan'     = "$([char]27)[96m"
    'brightwhite'    = "$([char]27)[97m"
}

class Animation {
    [System.Collections.Generic.List[object]] $frames
    [int] $frameCount = 0
    [string] $highlightColor = "$([char]27)[38;5;33m"
    [string] $resetColor = "$([char]27)[0m"
    [string[][]] $animationFrames = @()
    [int] $imageWidth = 77
    [int] $imageHeight = 41
    
    Animation([string[][]] $frames) {
        $this.animationFrames = $frames
        $this.frames = [System.Collections.Generic.List[object]]::new()
        $this.initializeFrames()
    }
    
    [void] initializeFrames() {
        $this.frameCount = $this.animationFrames.Count
        for ($i = 0; $i -lt $this.frameCount; $i++) {
            # Pre-process frames to handle color tags (from animation.ts)
            $processedFrame = $this.processFrame($this.animationFrames[$i])
            $this.frames.Add($processedFrame)
        }
    }
    
    [string[]] processFrame([string[]] $frameLines) {
        $processedLines = @()
        
        foreach ($line in $frameLines) {
            $processedLine = $this.processColorTags($line)
            $processedLines += $processedLine
        }
        
        return $processedLines
    }
    
    [string] processColorTags([string] $line) {
        # Process <c>...</c> color tags if present
        if ([string]::IsNullOrEmpty($line)) {
            return $line
        }
        
        $result = $line
        $colorStart = "<c>"
        $colorEnd = "</c>"
        $colorStartLen = $colorStart.Length
        $colorEndLen = $colorEnd.Length
        
        $maxIterations = 100
        $iteration = 0
        
        while ($result.Contains($colorStart) -and $iteration -lt $maxIterations) {
            $startIdx = $result.IndexOf($colorStart)
            if ($startIdx -eq -1) { break }
            
            $endIdx = $result.IndexOf($colorEnd, $startIdx)
            if ($endIdx -eq -1) { break }
            
            $before = $result.Substring(0, $startIdx)
            $contentStart = $startIdx + $colorStartLen
            $contentLen = $endIdx - $contentStart
            $colored = $result.Substring($contentStart, $contentLen)
            $after = $result.Substring($endIdx + $colorEndLen)
            
            $result = $before + $this.highlightColor + $colored + $this.resetColor + $after
            $iteration++
        }
        
        return $result
    }
    
    [string[]] getFrame([int] $index) {
        if ($this.frameCount -le 0) {
            return @()
        }
        $frameIndex = $index % $this.frameCount
        if ($frameIndex -lt 0 -or $frameIndex -ge $this.frames.Count) {
            return @()
        }
        return $this.frames[$frameIndex]
    }
    
    [void] setHighlightColor([string] $color) {
        $this.highlightColor = $color
    }
}

function Show-ContextAnimation {
    <#
    .SYNOPSIS
        Smooth frame-based animation inspired by Ghosttime with TypeScript features
    
    .PARAMETER Message
        Header message to display
    
    .PARAMETER Duration
        Animation duration in milliseconds
    
    .PARAMETER Color
        Color name (from ColorMap), ANSI code, or number
    
    .PARAMETER NoFocusPause
        Prevent animation from pausing when terminal loses focus
    
    .EXAMPLE
        Show-ContextAnimation -Message "Building context bridge" -Duration 3000
        Show-ContextAnimation -Message "Processing" -Duration 2000 -Color "brightblue"
    #>
    param(
        [string] $Message = "Contextify",
        [int] $Duration = 3000,
        [string] $Color = "blue",
        [switch] $NoFocusPause = $false
    )
    
    # Resolve color parameter (from TypeScript cli.ts)
    $resolvedColor = Resolve-AnimationColor -Color $Color
    
    # Create simple fallback animation frames (no external sourcing)
    $frames = @(
    # Frame 1 - Starting position (narrowest)
    @(
        "                                                                            ",
        "                                ++++++++++++                                ",
        "                        ++==*%%%**=++++++=**%%%*==++                        ",
        "                    ++**=*                        *=**++                    ",
        "                x+**+=                                =+**+x                ",
        "              ++==         o=%@@@@@@@@@@@@@@@@%=o         ==++              ",
        "            ===+       +#@@@@@################@@@@@#+       +===            ",
        "          ++=+      =@@@@##########################@@@@=      +=++          ",
        "        ++==      #@@##################################@@#      ==++        ",
        "        **      #@@######################################@@#      **        ",
        "      +++o    +@@##########################################@@+    o+++      ",
        "      ==     %@##############################################@%     ==      ",
        "    xx++    %@####@@@@@#######################################@%    ++xx    ",
        "    ==+.   x@###@@%=*%##@@@@@@@@@@@#####@@@@@@@@@@@@@@@@@@#####@x   .+==    ",
        "    ==     @####%                ~#@###@=                x@#####@     ==    ",
        "    ==     ####@*                  %##@.                   @#####     ==    ",
        "    ==    .@###@*                  ####+                   #####@.    ==    ",
        "    ==    .@#####~          ~ox+=%@@###@@*==============*#@#####@.    ==    ",
        "    ==    .@#####@@@@@@@@@@@@@@@@@#######@@@@@@@@@@@@@@@@#######@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    .@####################################################@.    ==    ",
        "    ==    ~######################################################~    ==    ",
        "    ==    .@####################################################@     ==    ",
        "    ==     #@##############@@@@##############@@@@##############@#     ==    ",
        "    ==+o    +@@@#######@@@#***%@@@@######@@@@%***#@@@#######@@@+    o+==    ",
        "    ++==      .=#@@@@@#*~        +%@@@@@@%+        ~*#@@@@@#=.      ==++    ",
        "      ===+                                                        +===      ",
        "      ++====x+            *=**==            ==**=*            +x====++      ",
        "        ++=====**%******=========**%****%**=========******%**=====++        ",
        "            ++++========++xx  ++++========++++  xx++========++++            ",
        "                                                                            "
    ),

    # Frame 2 - Slight expansion
    @(
        "                                                                            ",
        "                              ++++++++++++++++                              ",
        "                        ++==*%%%**==++++++==**%%%*==++                      ",
        "                    ++**=*                          *=**++                  ",
        "              x+**+=                                    =+**+x              ",
        "            ++==         o=%@@@@@@@@@@@@@@@@%=o           ==++              ",
        "          ===+       +#@@@@@################@@@@@#+         +===            ",
        "        ++=+      =@@@@##########################@@@@=        +=++          ",
        "      ++==      #@@##################################@@#        ==++        ",
        "      **      #@@######################################@@#        **        ",
        "    +++o    +@@##########################################@@+      o+++      ",
        "    ==     %@##############################################@%       ==      ",
        "  xx++    %@####@@@@@#######################################@%      ++xx    ",
        "  ==+.   x@###@@%=*%##@@@@@@@@@@@#####@@@@@@@@@@@@@@@@@@#####@x     .+==    ",
        "  ==     @####%                ~#@###@=                  x@#####@     ==    ",
        "  ==     ####@*                  %##@.                     @#####     ==    ",
        "  ==    .@###@*                  ####+                     #####@.    ==    ",
        "  ==    .@#####~          ~ox+=%@@###@@*==============*#@#####@.    ==    ",
        "  ==    .@#####@@@@@@@@@@@@@@@@@#######@@@@@@@@@@@@@@@@#######@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    ~######################################################~    ==    ",
        "  ==     .@####################################################@     ==    ",
        "  ==     #@##############@@@@##############@@@@##############@#     ==    ",
        "  ==+o    +@@@#######@@@#***%@@@@######@@@@%***#@@@#######@@@+    o+==    ",
        "  ++==      .=#@@@@@#*~        +%@@@@@@%+          ~*#@@@@@#=.      ==++    ",
        "    ===+                                                        +===        ",
        "    ++====x+            *=**==            ==**=*              +x====++      ",
        "      ++=====**%******=========**%****%**=========******%**=====++          ",
        "          ++++========++xx  ++++========++++  xx++========++++              ",
        "                                                                            "
    ),

    # Frame 3 - Medium expansion
    @(
        "                                                                            ",
        "                            ++++++++++++++++                                ",
        "                      ++==*%%%**==++++++==**%%%*==++                      ",
        "                  ++**=*                            *=**++                  ",
        "              x+**+=                                    =+**+x              ",
        "            ++==           o=%@@@@@@@@@@@@@@@@%=o           ==++            ",
        "          ===+         +#@@@@@################@@@@@#+         +===          ",
        "        ++=+        =@@@@##########################@@@@=        +=++        ",
        "      ++==        #@@##################################@@#        ==++      ",
        "      **        #@@######################################@@#        **      ",
        "    +++o      +@@##########################################@@+      o+++    ",
        "    ==       %@##############################################@%       ==    ",
        "  xx++      %@####@@@@@#######################################@%      ++xx  ",
        "  ==+.     x@###@@%=*%##@@@@@@@@@@@#####@@@@@@@@@@@@@@@@@@#####@x     .+==  ",
        "  ==       @####%                  ~#@###@=                  x@#####@       ==  ",
        "  ==       ####@*                    %##@.                    @#####       ==  ",
        "  ==      .@###@*                    ####+                    #####@.      ==  ",
        "  ==      .@#####~            ~ox+=%@@###@@*==============*#@#####@.      ==  ",
        "  ==      .@#####@@@@@@@@@@@@@@@@@#######@@@@@@@@@@@@@@@@#######@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      ~######################################################~      ==  ",
        "  ==       .@####################################################@       ==  ",
        "  ==       #@##############@@@@##############@@@@##############@#       ==  ",
        "  ==+o      +@@@#######@@@#***%@@@@######@@@@%***#@@@#######@@@+      o+==  ",
        "  ++==        .=#@@@@@#*~          +%@@@@@@%+          ~*#@@@@@#=.        ==++  ",
        "    ===+                                                          +===    ",
        "    ++====x+                *=**==            ==**=*                +x====++    ",
        "      ++=====**%******=========**%****%**=========******%**=====++      ",
        "          ++++========++xx      ++++========++++      xx++========++++          ",
        "                                                                            "
    ),

    # Frame 4 - Large expansion
    @(
        "                                                                            ",
        "                      +++==*%%%%%%%%%%%%*==+++                              ",
        "                  ++****++                    ++****++                      ",
        "              ++**++                                ++**++                  ",
        "          xx**+=              o+*%#@@@@@@#%*+o              =+**xx          ",
        "        xx**oo          =#@@@@@@@########@@@@@@@#=          oo**xx        ",
        "      xx**           x#@@@########################@@@#x           **xx      ",
        "    ox**          #@@################################@@#          **xo    ",
        "    ==+~        ~@@@####################################@@@~        ~+==    ",
        "  x+++       #@##########################################@#       +++x  ",
        "  ==        @@############################################@@        ==  ",
        " ox++      ~@################################################@~      ++xo ",
        " +++~      @#####@@@@@@@@@####################################@      ~+++ ",
        " ==       #####@@%%%%%%#######@@@@@###@@@@@@@@@@@@@@@@@@@@######       == ",
        " ==       @####*                      ####%                      =#####@       == ",
        " ==      .####@                       x@#@                       @#####.      == ",
        " ==      .@####%                     .####%                     *#####@.      == ",
        " ==      .@####@@#%%######@@@@@@@@####@@@@@@@@@@@@@@@@@@@@#####@.      == ",
        " ==      .@#######@@@@@########################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      ~######################################################~      == ",
        " ==       @@##################################################@@       == ",
        " ==x.     #@@#########@@@@@@@@@@########@@@@@@@@@@#########@@#     .+== ",
        " ++++       =@@@@@@@@@*         x#@@@@@@@@#x         *@@@@@@@@@=       ++++ ",
        " xx==++                                                  ++==oo ",
        "   ++===+            ++%%+o              o+%%++            +===++   ",
        "     ++=====%+=++++*=*========***++++***========*=*++++=+%=====++     ",
        "       xx++==******====++    ++==********==++    ++====******==++xx       ",
        "               ++++              ++++              ++++               ",
        "                                                                            "
    ),

    # Frame 5 - Maximum expansion (widest point)
    @(
        "                                                                            ",
        "                    +++==*%%%%%%%%%%%%%%*==+++                              ",
        "                ++****++                      ++****++                      ",
        "            ++**++                                  ++**++                  ",
        "        xx**+=                o+*%#@@@@@@#%*+o                =+**xx        ",
        "      xx**oo            =#@@@@@@@########@@@@@@@#=            oo**xx      ",
        "    xx**             x#@@@########################@@@#x             **xx    ",
        "  ox**            #@@################################@@#            **xo  ",
        "  ==+~          ~@@@####################################@@@~          ~+==  ",
        "x+++         #@##########################################@#         +++x",
        "==          @@############################################@@          ==",
        "ox++       ~@################################################@~       ++xo",
        "+++~       @#####@@@@@@@@@####################################@       ~+++",
        "==        #####@@%%%%%%#######@@@@@###@@@@@@@@@@@@@@@@@@@@######        ==",
        "==        @####*                        ####%                        =#####@        ==",
        "==       .####@                         x@#@                         @#####.       ==",
        "==       .@####%                       .####%                       *#####@.       ==",
        "==       .@####@@#%%######@@@@@@@@####@@@@@@@@@@@@@@@@@@@@#####@.       ==",
        "==       .@#######@@@@@########################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       .@####################################################@.       ==",
        "==       ~######################################################~       ==",
        "==        @@##################################################@@        ==",
        "==x.      #@@#########@@@@@@@@@@########@@@@@@@@@@#########@@#      .+==",
        "++++        =@@@@@@@@@*           x#@@@@@@@@#x           *@@@@@@@@@=        ++++",
        "xx==++                                                ++==oo",
        "  ++===+          ++%%+o                  o+%%++          +===++  ",
        "    ++=====%+=++++*=*========***++++***========*=*++++=+%=====++    ",
        "      xx++==******====++      ++==********==++      ++====******==++xx      ",
        "            ++++                  ++++                  ++++            ",
        "                                                                            "
    ),

    # Frame 6 - Start contracting (mirror of frame 4)
    @(
        "                                                                            ",
        "                      +++==*%%%%%%%%%%%%*==+++                              ",
        "                  ++****++                    ++****++                      ",
        "              ++**++                                ++**++                  ",
        "          xx**+=              o+*%#@@@@@@#%*+o              =+**xx          ",
        "        xx**oo          =#@@@@@@@########@@@@@@@#=          oo**xx        ",
        "      xx**           x#@@@########################@@@#x           **xx      ",
        "    ox**          #@@################################@@#          **xo    ",
        "    ==+~        ~@@@####################################@@@~        ~+==    ",
        "  x+++       #@##########################################@#       +++x  ",
        "  ==        @@############################################@@        ==  ",
        " ox++      ~@################################################@~      ++xo ",
        " +++~      @#####@@@@@@@@@####################################@      ~+++ ",
        " ==       #####@@%%%%%%#######@@@@@###@@@@@@@@@@@@@@@@@@@@######       == ",
        " ==       @####*                      ####%                      =#####@       == ",
        " ==      .####@                       x@#@                       @#####.      == ",
        " ==      .@####%                     .####%                     *#####@.      == ",
        " ==      .@####@@#%%######@@@@@@@@####@@@@@@@@@@@@@@@@@@@@#####@.      == ",
        " ==      .@#######@@@@@########################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      .@####################################################@.      == ",
        " ==      ~######################################################~      == ",
        " ==       @@##################################################@@       == ",
        " ==x.     #@@#########@@@@@@@@@@########@@@@@@@@@@#########@@#     .+== ",
        " ++++       =@@@@@@@@@*         x#@@@@@@@@#x         *@@@@@@@@@=       ++++ ",
        " xx==++                                                  ++==oo ",
        "   ++===+            ++%%+o              o+%%++            +===++   ",
        "     ++=====%+=++++*=*========***++++***========*=*++++=+%=====++     ",
        "       xx++==******====++    ++==********==++    ++====******==++xx       ",
        "               ++++              ++++              ++++               ",
        "                                                                            "
    ),

    # Frame 7 - Continue contracting (mirror of frame 3)
    @(
        "                                                                            ",
        "                            ++++++++++++++++                                ",
        "                      ++==*%%%**==++++++==**%%%*==++                      ",
        "                  ++**=*                            *=**++                  ",
        "              x+**+=                                    =+**+x              ",
        "            ++==           o=%@@@@@@@@@@@@@@@@%=o           ==++            ",
        "          ===+         +#@@@@@################@@@@@#+         +===          ",
        "        ++=+        =@@@@##########################@@@@=        +=++        ",
        "      ++==        #@@##################################@@#        ==++      ",
        "      **        #@@######################################@@#        **      ",
        "    +++o      +@@##########################################@@+      o+++    ",
        "    ==       %@##############################################@%       ==    ",
        "  xx++      %@####@@@@@#######################################@%      ++xx  ",
        "  ==+.     x@###@@%=*%##@@@@@@@@@@@#####@@@@@@@@@@@@@@@@@@#####@x     .+==  ",
        "  ==       @####%                  ~#@###@=                  x@#####@       ==  ",
        "  ==       ####@*                    %##@.                    @#####       ==  ",
        "  ==      .@###@*                    ####+                    #####@.      ==  ",
        "  ==      .@#####~            ~ox+=%@@###@@*==============*#@#####@.      ==  ",
        "  ==      .@#####@@@@@@@@@@@@@@@@@#######@@@@@@@@@@@@@@@@#######@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      .@####################################################@.      ==  ",
        "  ==      ~######################################################~      ==  ",
        "  ==       .@####################################################@       ==  ",
        "  ==       #@##############@@@@##############@@@@##############@#       ==  ",
        "  ==+o      +@@@#######@@@#***%@@@@######@@@@%***#@@@#######@@@+      o+==  ",
        "  ++==        .=#@@@@@#*~          +%@@@@@@%+          ~*#@@@@@#=.        ==++  ",
        "    ===+                                                          +===    ",
        "    ++====x+                *=**==            ==**=*                +x====++    ",
        "      ++=====**%******=========**%****%**=========******%**=====++      ",
        "          ++++========++xx      ++++========++++      xx++========++++          ",
        "                                                                            "
    ),

    # Frame 8 - Almost back to start (mirror of frame 2)
    @(
        "                                                                            ",
        "                              ++++++++++++++++                              ",
        "                        ++==*%%%**==++++++==**%%%*==++                      ",
        "                    ++**=*                          *=**++                  ",
        "              x+**+=                                    =+**+x              ",
        "            ++==         o=%@@@@@@@@@@@@@@@@%=o           ==++              ",
        "          ===+       +#@@@@@################@@@@@#+         +===            ",
        "        ++=+      =@@@@##########################@@@@=        +=++          ",
        "      ++==      #@@##################################@@#        ==++        ",
        "      **      #@@######################################@@#        **        ",
        "    +++o    +@@##########################################@@+      o+++      ",
        "    ==     %@##############################################@%       ==      ",
        "  xx++    %@####@@@@@#######################################@%      ++xx    ",
        "  ==+.   x@###@@%=*%##@@@@@@@@@@@#####@@@@@@@@@@@@@@@@@@#####@x     .+==    ",
        "  ==     @####%                ~#@###@=                  x@#####@     ==    ",
        "  ==     ####@*                  %##@.                     @#####     ==    ",
        "  ==    .@###@*                  ####+                     #####@.    ==    ",
        "  ==    .@#####~          ~ox+=%@@###@@*==============*#@#####@.    ==    ",
        "  ==    .@#####@@@@@@@@@@@@@@@@@#######@@@@@@@@@@@@@@@@#######@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    .@####################################################@.    ==    ",
        "  ==    ~######################################################~    ==    ",
        "  ==     .@####################################################@     ==    ",
        "  ==     #@##############@@@@##############@@@@##############@#     ==    ",
        "  ==+o    +@@@#######@@@#***%@@@@######@@@@%***#@@@#######@@@+    o+==    ",
        "  ++==      .=#@@@@@#*~        +%@@@@@@%+          ~*#@@@@@#=.      ==++    ",
        "    ===+                                                        +===        ",
        "    ++====x+            *=**==            ==**=*              +x====++      ",
        "      ++=====**%******=========**%****%**=========******%**=====++          ",
        "          ++++========++xx  ++++========++++  xx++========++++              ",
        "                                                                            "
    )
)

    $animation = [Animation]::new($frames)
    
    $animation.setHighlightColor($resolvedColor)
    
    # Setup terminal
    $supportsAnsi = $Host.UI.SupportsVirtualTerminal -eq $true -or $env:WT_SESSION
    $originalCursor = $null
    
    try {
        # Hide cursor
        try {
            if ($Host.UI.RawUI -and $Host.UI.RawUI.CursorSize) {
                try {
                    $originalCursor = $Host.UI.RawUI.CursorVisible
                    $Host.UI.RawUI.CursorVisible = $false
                } catch { }
            }
        } catch { }
        
        # Get terminal dimensions
        $width = if ($Host.UI.RawUI.WindowSize) { $Host.UI.RawUI.WindowSize.Width } else { 80 }
        $height = if ($Host.UI.RawUI.WindowSize) { $Host.UI.RawUI.WindowSize.Height } else { 24 }
        
        # Color palette
        $reset = if ($supportsAnsi) { "$([char]27)[0m" } else { "" }
        $cyan = if ($supportsAnsi) { "$([char]27)[38;5;80m" } else { "" }
        $blue = if ($supportsAnsi) { "$([char]27)[38;5;33m" } else { "" }
        $gray = if ($supportsAnsi) { "$([char]27)[38;5;242m" } else { "" }
        $border = if ($supportsAnsi) { "$([char]27)[38;5;237m" } else { "" }
        
        # Display header
        Write-Host "`n${border}===================================${reset}"
        Write-Host "$($blue)CONTEXTIFY${reset}"
        Write-Host "${border}===================================${reset}`n"
        
        # Render animation with advanced centering (from TypeScript)
        $startTime = Get-Date
        $frameDelay = 30  # milliseconds (MICROS_PER_FRAME / 1000 from cli.ts)
        $frameIndex = 0
        $lastRenderedFrame = -1
        
        # Calculate centering once (from TypeScript renderFrame)
        $imageWidth = $animation.imageWidth
        $imageHeight = $animation.imageHeight
        $verticalPadding = [Math]::Max(0, [int](($height - $imageHeight) / 2))
        $horizontalPadding = [Math]::Max(0, [int](($width - $imageWidth) / 2))
        $padStr = " " * $horizontalPadding
        
        while ($true) {
            $elapsed = ((Get-Date) - $startTime).TotalMilliseconds
            
            if ($elapsed -ge $Duration) {
                break
            }
            
            # Calculate frame with intelligent frame skipping (from TypeScript)
            $frameIndex = [int]($elapsed / $frameDelay)
            
            # Only render if frame changed
            if ($frameIndex -ne $lastRenderedFrame -and $frameIndex -ge 0) {
                $frame = $animation.getFrame($frameIndex)
                
                if ($frame -and $frame.Count -gt 0) {
                    # Build complete output as string before writing
                    $output = @()
                    
                    # Add vertical padding
                    for ($v = 0; $v -lt $verticalPadding; $v++) {
                        $output += ""
                    }
                    
                    # Add frame lines with horizontal padding
                    foreach ($line in $frame) {
                        if ([string]::IsNullOrEmpty($line)) {
                            $output += ""
                        } else {
                            $output += "${padStr}${line}"
                        }
                    }
                    
                    # Add progress indicator
                    $progress = [Math]::Floor(($elapsed / $Duration) * 100)
                    $output += "`n${gray}[${blue}$progress%${gray}]${reset} ${cyan}${Message}${reset}"
                    
                    # Clear and render in one operation
                    Clear-Host
                    Write-Host ($output -join "`n")
                    
                    $lastRenderedFrame = $frameIndex
                }
            }
            
            # Frame timing
            Start-Sleep -Milliseconds 1
        }
        
        # Completion
        Write-Host "`n${blue}[OK]${reset} ${gray}Context bridge established${reset}`n"
        
    } finally {
        # Restore cursor
        if ($originalCursor -ne $null) {
            try {
                if ($Host.UI.RawUI -and $Host.UI.RawUI.CursorSize) {
                    try {
                        $Host.UI.RawUI.CursorVisible = $originalCursor
                    } catch { }
                }
            } catch { }
        }
    }
}

# Helper function to resolve animation color parameter (from TypeScript cli.ts)
function Resolve-AnimationColor {
    param(
        [string] $Color = "blue"
    )
    
    # Check if it's already an ANSI code
    if ($Color -like "$([char]27)*") {
        return $Color
    }
    
    # Check if it's a number (ANSI color code)
    if ($Color -match '^\d+$') {
        return "$([char]27)[$($Color)m"
    }
    
    # Check if it's in the color map
    if ($global:ColorMap.ContainsKey($Color.ToLower())) {
        return $global:ColorMap[$Color.ToLower()]
    }
    
    # Default to blue if not found
    return $global:ColorMap['blue']
}

function Show-ProcessingAnimation {
    <#
    .SYNOPSIS
        Fast processing animation with simple spinner
    
    .PARAMETER Message
        Operation description
    
    .PARAMETER Duration
        Animation duration in milliseconds
    #>
    param(
        [Parameter(Mandatory=$true)] [string] $Message,
        [int] $Duration = 1000
    )
    
    $supportsAnsi = $Host.UI.SupportsVirtualTerminal -eq $true -or $env:WT_SESSION
    $spinnerChars = @("*", "+", "*", "+")
    
    $blue = if ($supportsAnsi) { "$([char]27)[38;5;33m" } else { "" }
    $green = if ($supportsAnsi) { "$([char]27)[38;5;76m" } else { "" }
    $gray = if ($supportsAnsi) { "$([char]27)[38;5;242m" } else { "" }
    $reset = if ($supportsAnsi) { "$([char]27)[0m" } else { "" }
    
    try {
        try {
            if ($Host.UI.RawUI -and $Host.UI.RawUI.CursorSize) {
                $Host.UI.RawUI.CursorVisible = $false
            }
        } catch { }
        
        $startTime = Get-Date
        $i = 0
        
        while (((Get-Date) - $startTime).TotalMilliseconds -lt $Duration) {
            $char = $spinnerChars[$i % 4]
            $progress = (((Get-Date) - $startTime).TotalMilliseconds / $Duration)
            $color = if ($progress -gt 0.9) { $green } else { $blue }
            
            Write-Host "`r${color}${char}${reset} ${gray}${Message}${reset}" -NoNewline
            Start-Sleep -Milliseconds 75
            $i++
        }
        
        Write-Host "`r${green}[OK]${reset} ${gray}${Message}${reset}    "
        
    } finally {
        try {
            if ($Host.UI.RawUI -and $Host.UI.RawUI.CursorSize) {
                $Host.UI.RawUI.CursorVisible = $true
            }
        } catch { }
    }
}

# Alias for backward compatibility
function Show-Spinner {
    <#
    .SYNOPSIS
        Spinner animation (alias to Show-ProcessingAnimation)
    
    .PARAMETER Message
        Operation description
    
    .PARAMETER Duration
        Animation duration in milliseconds
    #>
    param(
        [Parameter(Mandatory=$true)] [string] $Message,
        [int] $Duration = 1000
    )
    
    Show-ProcessingAnimation -Message $Message -Duration $Duration
}

# Demo mode
if ($MyInvocation.InvocationName -eq '.' -or $MyInvocation.MyCommand.Path -eq $PSCommandPath) {
    Clear-Host
    
    Show-ContextAnimation -Message "Building context bridge" -Duration 2500 -Color "$([char]27)[38;5;33m"
    Start-Sleep -Milliseconds 500
    
    Show-ProcessingAnimation -Message "Auto-loading .env configuration" -Duration 750
    Show-ProcessingAnimation -Message "Filtering sensitive files" -Duration 650
    Show-ProcessingAnimation -Message "Detecting framework patterns" -Duration 850
    
    Write-Host "`n$([char]27)[38;5;76m[OK]$([char]27)[0m $([char]27)[38;5;242mAnimation system ready$([char]27)[0m`n"
}
